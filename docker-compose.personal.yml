# Skylytics - Personal Hypixel Skyblock Auction Tracker
# Simplified docker-compose for personal use - no payment required
version: '3.7'

services:
  # Main API server
  skylytics-api:
    build: .
    ports:
      - "5000:5000"
    environment:
      - ASPNETCORE_URLS=http://+:5000
      - ASPNETCORE_ENVIRONMENT=Production
      - DBConnection=server=mariadb;port=3306;database=skylytics;user=root;password=takenfrombitnami;convert zero datetime=True;Charset=utf8;Connect Timeout=30
      - DBVersion=10.11
      - REDIS_HOST=redis:6379
      - redisCon=redis:6379
      - KAFKA_HOST=kafka:9092
      - EnableRateLimiting=false
      - ITEMS_BASE_URL=http://items:8000
    depends_on:
      - mariadb
      - redis
    restart: unless-stopped
    networks:
      - skylytics-network

  # MariaDB Database
  mariadb:
    image: 'docker.io/bitnami/mariadb:10.11-debian-11'
    volumes:
      - 'skylytics_db:/bitnami/mariadb'
    ports:
      - '3306:3306'
    environment:
      - MARIADB_ROOT_PASSWORD=takenfrombitnami
      - MARIADB_DATABASE=skylytics
      - MARIADB_EXTRA_FLAGS=--innodb-buffer-pool-size=500M --key-buffer-size=1G --connect-timeout=101
    restart: unless-stopped
    networks:
      - skylytics-network

  # Redis Cache
  redis:
    image: "redis:alpine"
    ports:
      - "6379:6379"
    volumes:
      - 'skylytics_redis:/data'
    restart: unless-stopped
    networks:
      - skylytics-network

  # phpMyAdmin for database management (optional)
  phpmyadmin:
    image: 'docker.io/bitnami/phpmyadmin:5-debian-10'
    ports:
      - '8080:8080'
    environment:
      - DATABASE_HOST=mariadb
    depends_on:
      - mariadb
    restart: unless-stopped
    networks:
      - skylytics-network

  # Kafka for message streaming (required for real-time updates)
  zookeeper:
    image: docker.io/bitnami/zookeeper:3.7
    ports:
      - "2181:2181"
    volumes:
      - "skylytics_zookeeper:/bitnami"
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    restart: unless-stopped
    networks:
      - skylytics-network

  kafka:
    image: docker.io/bitnami/kafka:2
    ports:
      - "9092:9092"
    volumes:
      - "skylytics_kafka:/bitnami"
    environment:
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
    depends_on:
      - zookeeper
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1500M
    networks:
      - skylytics-network

networks:
  skylytics-network:
    driver: bridge

volumes:
  skylytics_db:
    driver: local
  skylytics_redis:
    driver: local
  skylytics_zookeeper:
    driver: local
  skylytics_kafka:
    driver: local
